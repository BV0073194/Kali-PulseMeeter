#!/usr/bin/env python3
import shutil
import os
import json
import re
import sys
import subprocess
from pathlib import Path
from gi import require_version as gi_require_version
gi_require_version('Gtk', '3.0')

from gi.repository import Gtk,Gdk

PIDFILE = '/tmp/pulsemeeter.pid'

class Pulse:

    def __init__(self, config):
        command = ''
        command = command + self.start_sinks(config)
        command = command + self.start_sources(config)
        command = command + self.start_eqs(config)
        command = command + self.start_rnnoise(config)
        command = command + self.start_mute(config)
        command = command + self.start_conections(config)
        # print(command)
        os.popen(command)

    def get_correct_device(self, config, index, conn_type):
        if index[0] == 'vi':
            name = config[index[0]][index[1]]['name']
            if conn_type == "source":
                return name + ".monitor"
            else:
                return name

        if index[0] == 'hi':
            if config[index[0]][index[1]]['use_rnnoise'] == True:
                name = config[index[0]][index[1]]['rnnoise_name']
                return name + ".monitor"
            else:
                name = config[index[0]][index[1]]['name']
                return name

        if index[0] == 'a':
            if config[index[0]][index[1]]['use_eq'] == True:
                name = config[index[0]][index[1]]['eq_name']
                return name
            else:
                name = config[index[0]][index[1]]['name']
                return name

        if index[0] == 'b':
            if config[index[0]][index[1]]['use_eq'] == True:
                name = config[index[0]][index[1]]['eq_name']
                if conn_type == 'source':
                    name = name + ".monitor"
                return name
            else:
                name = config[index[0]][index[1]]['name'] + "_sink"
                if conn_type == 'source':
                    name = name + ".monitor"
                return name


    def start_sinks(self, config):
        command = ''
        sink_list = cmd("pactl list sinks short")
        for i in range(1, len(config['vi']) + 1):
            if(config['vi'][str(i)]['name'] != ''):
                if not re.search(config['vi'][str(i)]['name'], sink_list):
                    sink = config['vi'][str(i)]['name']
                    command = command + f"pmctl init sink {sink}\n"
        return command

    def start_sources(self, config):
        command = ''
        source_list = cmd("pactl list sources short")
        for i in range(1, len(config['b']) + 1):
            if(config['b'][str(i)]['name'] != ''):
                if not re.search(config['b'][str(i)]['name'], source_list):
                    source = config['b'][str(i)]['name']
                    command = command + f"pmctl init source {source}\n"
        return command

    def start_eqs(self, config):
        command = ''
        for i in ['a','b']:
            for j in range(1, 4):
                if config[i][str(j)]['use_eq'] == True:
                    command = command + self.apply_eq(config, [i, str(j)], config[i][str(j)]['eq_name'], config[i][str(j)]['eq_control'], 'init')

        return command

    def start_rnnoise(self, config):
        command = ''
        for j in range(1, 4):
            if config['hi'][str(j)]['use_rnnoise'] == True:
                source_index = ['hi', str(j)]
                sink_name = config['hi'][str(j)]['rnnoise_name']
                command = command + self.rnnoise(config, source_index, sink_name, "connect", 'init')
        return command

    def start_conections(self, config):
        command = ''
        for i in ['vi', 'hi']:
            for j in ['1', '2', '3']:
                source = self.get_correct_device(config, [i, j], 'source')

                for sink_num in ['a1', 'a2', 'a3', 'b1', 'b2', 'b3']:
                    sink_list = list(sink_num)

                    sink = self.get_correct_device(config, [sink_list[0], sink_list[1]], 'sink') 

                    if config[i][j][sink_num] == True:
                        latency = config[i][j][sink_num + "_latency"]
                        command = command +  f"pmctl connect {source} {sink} {latency}\n"
        return command

    def start_mute(self, config):
        command = ''
        for i in ['a', 'b']:
            for j in ['1', '2', '3']:
                if config[i][j]['mute'] == True:
                    device = 'sink' if i == 'a' else 'source'
                    command = command + self.mute(config, [i, j], device, 1, 'init')

        return command

    def rnnoise(self, config, source_index, sink_name, stat, init=''):
        source = config[source_index[0]][source_index[1]]['name']
        control = config[source_index[0]][source_index[1]]['rnnoise_control']
        latency = config[source_index[0]][source_index[1]]['rnnoise_latency']
        config[source_index[0]][source_index[1]]['use_rnnoise'] = True if stat == 'connect' else False
        config[source_index[0]][source_index[1]]['rnnoise_name'] = sink_name
        command = f'pmctl rnnoise {sink_name} {source} {control} {stat} {latency}\n'

        if init != 'init':
            for i in ['a1','a2','a3','b1','b2','b3']:
                if config[source_index[0]][source_index[1]][i] == True:
                    output = list(i)
                    output_dev = self.get_correct_device(config, [output[0], output[1]], 'sink') 
                    latency = config[source_index[0]][source_index[1]][i + "_latency"]
                    if stat == 'connect':
                        command = command + f'pmctl disconnect {source} {output_dev}\n'
                        command = command + f'pmctl connect {sink_name}.monitor {output_dev} {latency}\n'
                    else:
                        command = command + f'pmctl connect {source} {output_dev} {latency}\n'
            if init != 'cmd_only':
                os.popen(command)

        # print(command)
        return command
        
    def reconnect(self, config, device, number, init=''):
        sink_sufix = '' if device == 'hi' else '.monitor'
        command = ''
        for output in ['a1','a2','a3','b1','b3','b3']:
            dev = list(output)
            source_index = [device, str(number)]
            sink_index = [dev[0], dev[1]]
            if config[device][str(number)][output] == True:
                command = command + self.connect(config, "connect", source_index, sink_index, init)
        return command

    def connect(self, config, state, source_index, sink_index, init=''):
        config[source_index[0]][source_index[1]][sink_index[0] + sink_index[1]] = True if state == "connect" else False
        source = self.get_correct_device(config, source_index, 'source')
        sink = self.get_correct_device(config, sink_index, 'sink')
        latency = config[source_index[0]][source_index[1]][sink_index[0] + sink_index[1] + "_latency"]
        command = f"pmctl {state} {source} {sink} {latency}\n"
        # print(command)
        if init != 'init':
            os.popen(command)
        return command

    def volume(self, config, device_type, index, val):
        config[index[0]][index[1]]['vol'] = val
        name = config[index[0]][index[1]]['name']

        if (name == '' or device_type == ''):
            return
        command = f"pmctl volume {device_type} {name} {val}"
        # print(command)
        os.popen(command)

    def rename(self, config, device_index, new_name):
        old_name = config[device_index[0]][device_index[1]]['name']
        if new_name == old_name:
            return False

        if old_name != '':
            command = f'pmctl remove {old_name}'
            # print(command)
            os.popen(command)

        if new_name != '':
            config[device_index[0]][device_index[1]]['name'] = new_name
            command = f'pmctl init sink {new_name}\n'
            command = command + self.reconnect(config, device_index[0], device_index[1], 'init')
            # print(command)
            os.popen(command)

        return True


    def get_hardware_devices(self, kind):
        command = f"pmctl list {kind}"
        devices = cmd(command).split('\n')
        devices_concat = []
        for i in range(0, len(devices)-1, 2):
            devices_concat.append([devices[i], devices[i + 1]])
        return devices_concat

    def mute(self, config, index, device, state, init=''):
        name = config[index[0]][index[1]]['name']
        config[index[0]][index[1]]['mute'] = True if state == 1 else False
        if name == '':
            return

        command = f"pmctl mute {device} {name} {state}\n"
        if init != 'init':
            os.popen(command)
        # print(command)
        return command

    def apply_eq(self, config, index, name, control, status=''):
        master = config[index[0]][index[1]]['name']

        config[index[0]][index[1]]['eq_control'] = control
        config[index[0]][index[1]]['use_eq'] = True
        config[index[0]][index[1]]['eq_name'] = name

        if index[0] == 'b':
            master = master + "_sink"

        command = f'pmctl eq {name} {master} {control}\n'
        if status != 'init':
            output = index[0] + index[1]
            for i in ['hi', 'vi']:
                for j in range (1, 4):
                    if config[i][str(j)][output] == True:
                        vi = config[i][str(j)]['name']

                        if i == 'hi' and config[i][str(j)]['use_rnnoise'] == True:
                            vi = config[i][str(j)]['rnnoise_name'] + '.monitor'

                        command = command + f'pmctl disconnect {vi} {master}\n'

                        vi = vi + '.monitor' if i == 'vi' else vi
                        command = command + f'pmctl connect {vi} {name}\n'

            os.popen(command)

        return command

    def remove_eq(self, config, master, name, output, index):
        config[index[0]][index[1]]['use_eq'] = False
        command = f'pmctl eq {name} remove\n'

        for i in ['hi', 'vi']:
            for j in range (1, 4):
                if config[i][str(j)][output] == True:
                    vi = config[i][str(j)]['name']
                    if i == 'hi' and config[i][str(j)]['use_rnnoise'] == True:
                        vi = config[i][str(j)]['rnnoise_name'] + '.monitor'

                    if i == 'vi':
                        vi = vi + '.monitor'
                    elif list(output)[0] == 'b':
                        master = master + '_sink'
                    command = command + f'pmctl connect {vi} {master}\n'

        os.popen(command)

    
class Latency_Popup():
    def __init__(self, button, pulse, config, gladefile, index):

        self.config = config
        self.builder = Gtk.Builder()

        try:
            self.builder.add_objects_from_file(
                gladefile,
                [
                    'Latency_Popover',
                    'Latency_Adjust',
                    'Apply_Latency_Button',
                ]
            )
        except Exception as ex:
            print('Error building main window!\n{}'.format(ex))
            sys.exit(1)

        self.Latency_Popover = self.builder.get_object('Latency_Popover')
        self.Latency_Popover.set_relative_to(button)

        self.Latency_Adjust = self.builder.get_object('Latency_Adjust')
        self.Latency_Adjust.set_value(self.config[index[0]][index[1]][index[2] + '_latency'])
        # self.Latency_Adjust.connect('value_changed', self.latency_adjust, [index[0], index[1], index[2] + '_latency'])
        self.Apply_Latency_Button = self.builder.get_object('Apply_Latency_Button')
        self.Apply_Latency_Button.connect('pressed', self.apply_latency, index, pulse)


        self.Latency_Popover.popup()

    # def latency_adjust(self, widget, index):
        # val = int(widget.get_value())
        # self.config[index[0]][index[1]][index[2]] = val

    def apply_latency(self, widget, index, pulse):
        val = int(self.Latency_Adjust.get_value())
        self.config[index[0]][index[1]][index[2] + '_latency'] = val
        if self.config[index[0]][index[1]][index[2]] == False:
            return
        dev = list(index[2])
        command = ''
        command = command + pulse.connect(self.config, 'disconnect', [index[0], index[1]], dev, 'init')
        command = command + pulse.connect(self.config, 'connect', [index[0], index[1]], dev, 'init')
        # print(command)
        os.popen(command)

class Noisetorch_Popup():
    def __init__(self, button, config, pulse, gladefile, index):

        self.config = config
        self.builder = Gtk.Builder()

        try:
            self.builder.add_objects_from_file(
                gladefile,
                [
                    'Noisetorch_Popover',
                    'Noisetorch_Latency_Adjust',
                    'Noisetorch_Threshold_Adjust',
                    'Apply_Noisetorch_Button',
                ]
            )
        except Exception as ex:
            print('Error building main window!\n{}'.format(ex))
            sys.exit(1)

        self.Noisetorch_Popover = self.builder.get_object('Noisetorch_Popover')
        self.Noisetorch_Popover.set_relative_to(button)

        self.Noisetorch_Latency_Adjust = self.builder.get_object('Noisetorch_Latency_Adjust')
        self.Noisetorch_Latency_Adjust.set_value(self.config[index[0]][index[1]]['rnnoise_latency'])
        # self.Noisetorch_Latency_Adjust.connect('value_changed', self.latency_adjust, [index[0], index[1]])

        self.Noisetorch_Threshold_Adjust = self.builder.get_object('Noisetorch_Threshold_Adjust')
        self.Noisetorch_Threshold_Adjust.set_value(self.config[index[0]][index[1]]['rnnoise_control'])
        # self.Noisetorch_Threshold_Adjust.connect('value_changed', self.threshold_adjust, [index[0], index[1]])

        self.Apply_Noisetorch_Button = self.builder.get_object('Apply_Noisetorch_Button')
        self.Apply_Noisetorch_Button.connect('pressed', self.apply_button, index, pulse)

        self.Noisetorch_Popover.popup()

    # def latency_adjust(self, widget, index):
        # val = int(widget.get_value())
        # self.config[index[0]][index[1]]['rnnoise_latency'] = val

    # def threshold_adjust(self, widget, index):
        # val = int(widget.get_value())
        # self.config[index[0]][index[1]]['rnnoise_control'] = val

    def apply_button(self, widget, index, pulse):
        val = int(self.Noisetorch_Latency_Adjust.get_value())
        self.config[index[0]][index[1]]['rnnoise_latency'] = val
        val = int(self.Noisetorch_Threshold_Adjust.get_value())
        self.config[index[0]][index[1]]['rnnoise_control'] = val

        if self.config[index[0]][index[1]]['use_rnnoise'] == False:
            return
        sink_name = self.config[index[0]][index[1]]['rnnoise_name']
        command = ''
        command = command + pulse.rnnoise(self.config, index, sink_name, 'disconnect', 'cmd_only')
        command = command + pulse.rnnoise(self.config, index, sink_name, 'connect', 'cmd_only')
        # print(command)
        os.popen(command)


class EqPopover():

    def __init__(self, button, config, pulse, gladefile, index, name):

        self.config = config
        self.builder = Gtk.Builder()
        self.pulse = pulse

        try:
            self.builder.add_objects_from_file(
                gladefile,
                [
                    'EQ_Popup',
                    'EQ_50_hz_Adjust',
                    'EQ_100_hz_Adjust',
                    'EQ_156_hz_Adjust',
                    'EQ_220_hz_Adjust',
                    'EQ_311_hz_Adjust',
                    'EQ_440_hz_Adjust',
                    'EQ_622_hz_Adjust',
                    'EQ_880_hz_Adjust',
                    'EQ_1_25_khz_Adjust',
                    'EQ_1_75_khz_Adjust',
                    'EQ_2_5_khz_Adjust',
                    'EQ_3_5_khz_Adjust',
                    'EQ_5_khz_Adjust',
                    'EQ_10_khz_Adjust',
                    'EQ_20_khz_Adjust',
                    'Apply_EQ_Button',
                    'Reset_EQ_Button',
                ]
            )
        except Exception as ex:
            print('Error building main window!\n{}'.format(ex))
            sys.exit(1)


        self.eq = []
        self.eq.append(self.builder.get_object('EQ_50_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_100_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_156_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_220_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_311_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_440_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_622_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_880_hz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_1_25_khz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_1_75_khz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_2_5_khz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_3_5_khz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_5_khz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_10_khz_Adjust'))
        self.eq.append(self.builder.get_object('EQ_20_khz_Adjust'))
        self.Apply_EQ_Button = self.builder.get_object('Apply_EQ_Button')
        self.Reset_EQ_Button = self.builder.get_object('Reset_EQ_Button')

        control = self.config[index[0]][index[1]]['eq_control'] 
        j = 0
        if control != '':
            for i in control.split(','):
                self.eq[j].set_value(float(i))
                j = j + 1

        self.Apply_EQ_Button.connect('pressed', self.apply_eq, index, name)
        self.Reset_EQ_Button.connect('pressed', self.reset_eq)

        self.EQ_Popup = self.builder.get_object('EQ_Popup')

        self.EQ_Popup.set_relative_to(button)
        self.EQ_Popup.popup()

        self.builder.connect_signals(self)

    def apply_eq(self, widget, index, name):
        control=''
        for i in self.eq:
            control = control + ',' + str(i.get_value())
        control = control[1:]
        if self.config[index[0]][index[1]]['use_eq'] == False:
            return
        self.pulse.apply_eq(self.config, index, name, control)

    def disable_eq(self, widget, index, name):
        # self.config[index[0]][index[1]]['eq_control'] = ''
        self.config[index[0]][index[1]]['use_eq'] = False
        master = self.config[index[0]][index[1]]['name']
        output = index[0] + index[1]

        self.pulse.remove_eq(self.config, master, name, output, index)

    def reset_eq(self, widget):
        for i in self.eq:
            i.set_value(0)

    def reset_value(self, widget, event):
        if event.type == gtk.gdk.BUTTON_PRESS and event.button == 3:
            widget.set_value(0)

    def delete_event(self, widget, event, donnees=None):
        pass



class MainWindow(Gtk.Window):

    def __init__(self, config, pulse):
        self.config = config
        Gtk.Window.__init__(self)
        self.builder = Gtk.Builder()
        
        gladefile = ''
        # gladefile = get_config_path(True)
        if not os.path.exists(gladefile):
            gladefile = '/usr/local/share/doc/pulsemeeter/Interface.glade'
            if not os.path.exists(gladefile):
                gladefile = '/usr/share/doc/pulsemeeter/Interface.glade'
                if not os.path.exists(gladefile):
                    gladefile = get_config_path(True)
                else:
                    shutil.copy(gladefile, get_config_path(True))
            else:
                shutil.copy(gladefile, get_config_path(True))
        self.gladefile = gladefile

        try:
            self.builder.add_objects_from_file(
                gladefile,
                [
                    'Popover',
                    'Popover_Entry',
                    'Latency_Popover',
                    'Latency_Adjust',
                    'Noisetorch_Popover',
                    'Noisetorch_Latency_Adjust',
                    'Noisetorch_Threshold_Adjust',
                    'A1_Combobox',
                    'A2_Combobox',
                    'A3_Combobox',

                    'Hardware_Input_1_Combobox',
                    'Hardware_Input_2_Combobox',
                    'Hardware_Input_3_Combobox',

                    'Hardware_Input_1_Noisetorch',
                    'Hardware_Input_2_Noisetorch',
                    'Hardware_Input_3_Noisetorch',

                    'Hardware_Input_1_Adjust',
                    'Hardware_Input_1_A1',
                    'Hardware_Input_1_A2',
                    'Hardware_Input_1_A3',
                    'Hardware_Input_1_B1',
                    'Hardware_Input_1_B2',
                    'Hardware_Input_1_B3',

                    'Hardware_Input_2_Adjust',
                    'Hardware_Input_2_A1',
                    'Hardware_Input_2_A2',
                    'Hardware_Input_2_A3',
                    'Hardware_Input_2_B1',
                    'Hardware_Input_2_B2',
                    'Hardware_Input_2_B3',

                    'Hardware_Input_3_Adjust',
                    'Hardware_Input_3_A1',
                    'Hardware_Input_3_A2',
                    'Hardware_Input_3_A3',
                    'Hardware_Input_3_B1',
                    'Hardware_Input_3_B2',
                    'Hardware_Input_3_B3',

                    'Virtual_Input_1_Adjust',
                    'Virtual_Input_1_A1',
                    'Virtual_Input_1_A2',
                    'Virtual_Input_1_A3',
                    'Virtual_Input_1_B1',
                    'Virtual_Input_1_B2',
                    'Virtual_Input_1_B3',

                    'Virtual_Input_2_Adjust',
                    'Virtual_Input_2_A1',
                    'Virtual_Input_2_A2',
                    'Virtual_Input_2_A3',
                    'Virtual_Input_2_B1',
                    'Virtual_Input_2_B2',
                    'Virtual_Input_2_B3',

                    'Virtual_Input_3_Adjust',
                    'Virtual_Input_3_A1',
                    'Virtual_Input_3_A2',
                    'Virtual_Input_3_A3',
                    'Virtual_Input_3_B1',
                    'Virtual_Input_3_B2',
                    'Virtual_Input_3_B3',

                    'Mute_A1',
                    'Mute_A2',
                    'Mute_A3',
                    'Mute_B1',
                    'Mute_B2',
                    'Mute_B3',

                    'EQ_A1',
                    'EQ_A2',
                    'EQ_A3',
                    'EQ_B1',
                    'EQ_B2',
                    'EQ_B3',

                    'Master_A1_Adjust',
                    'Master_A2_Adjust',
                    'Master_A3_Adjust',
                    'Master_B1_Adjust',
                    'Master_B2_Adjust',
                    'Master_B3_Adjust',

                    'Window'
                ]
            )
        except Exception as ex:
            print('Error building main window!\n{}'.format(ex))
            sys.exit(1)

        self.pulse = pulse
        self.init = True

        self.src_list = Gtk.ListStore(str)
        self.src_concat = self.pulse.get_hardware_devices("sources")

        self.Hardware_Input_1_Combobox = self.builder.get_object('Hardware_Input_1_Combobox')
        self.Hardware_Input_2_Combobox = self.builder.get_object('Hardware_Input_2_Combobox')
        self.Hardware_Input_3_Combobox = self.builder.get_object('Hardware_Input_3_Combobox')

        self.Hardware_Input_1_Combobox.append_text("")
        self.Hardware_Input_2_Combobox.append_text("")
        self.Hardware_Input_3_Combobox.append_text("")
        for device in self.src_concat:
            self.Hardware_Input_1_Combobox.append_text(device[1][:20] + '...')
            self.Hardware_Input_2_Combobox.append_text(device[1][:20] + '...')
            self.Hardware_Input_3_Combobox.append_text(device[1][:20] + '...')

        index = [-1, -1, -1]
        for j in range(1, 4):
            for i in range(0, len(self.src_concat)):
                if self.src_concat[i][0] == self.config['hi'][str(j)]['name']:
                    index[j - 1] = i + 1
                    break;

        self.Hardware_Input_1_Combobox.set_active(index[0])
        self.Hardware_Input_2_Combobox.set_active(index[1])
        self.Hardware_Input_3_Combobox.set_active(index[2])
        self.Hardware_Input_1_Combobox.connect("changed", self.on_combo_changed, ['hi','1'], self.src_concat)
        self.Hardware_Input_2_Combobox.connect("changed", self.on_combo_changed, ['hi','2'], self.src_concat)
        self.Hardware_Input_3_Combobox.connect("changed", self.on_combo_changed, ['hi','3'], self.src_concat)

        self.device_list = Gtk.ListStore(str)
        self.devices_concat = self.pulse.get_hardware_devices("sinks")

        self.A1_Combobox = self.builder.get_object('A1_Combobox')
        self.A2_Combobox = self.builder.get_object('A2_Combobox')
        self.A3_Combobox = self.builder.get_object('A3_Combobox')

        self.A1_Combobox.append_text("")
        self.A2_Combobox.append_text("")
        self.A3_Combobox.append_text("")
        for device in self.devices_concat:
            self.A1_Combobox.append_text(device[1])
            self.A2_Combobox.append_text(device[1])
            self.A3_Combobox.append_text(device[1])

        index = [-1, -1, -1]
        for j in range(1, 4):
            for i in range(0, len(self.devices_concat)):
                if self.devices_concat[i][0] == self.config['a'][str(j)]['name']:
                    index[j - 1] = i + 1
                    break;

        self.A1_Combobox.set_active(index[0])
        self.A2_Combobox.set_active(index[1])
        self.A3_Combobox.set_active(index[2])
        self.A1_Combobox.connect("changed", self.on_combo_changed, ['a','1'], self.devices_concat)
        self.A2_Combobox.connect("changed", self.on_combo_changed, ['a','2'], self.devices_concat)
        self.A3_Combobox.connect("changed", self.on_combo_changed, ['a','3'], self.devices_concat)

        self.Hardware_Input_1_Adjust = self.builder.get_object('Hardware_Input_1_Adjust')
        self.Hardware_Input_1_Adjust.set_value(self.config['hi']['1']['vol'])
        self.Hardware_Input_1_Adjust.connect('value-changed', self.slider_change, "source", ['hi', '1']) # self.config['hi']['1']['name'], ['vol','hi','1'])
        self.Hardware_Input_1_Noisetorch = self.builder.get_object('Hardware_Input_1_Noisetorch')
        self.Hardware_Input_2_Noisetorch = self.builder.get_object('Hardware_Input_2_Noisetorch')
        self.Hardware_Input_3_Noisetorch = self.builder.get_object('Hardware_Input_3_Noisetorch')

        self.Hardware_Input_1_Noisetorch.set_active(self.config['hi']['1']['use_rnnoise'])
        self.Hardware_Input_2_Noisetorch.set_active(self.config['hi']['2']['use_rnnoise'])
        self.Hardware_Input_3_Noisetorch.set_active(self.config['hi']['3']['use_rnnoise'])

        self.Hardware_Input_1_Noisetorch.connect('toggled', self.rnnoise_toggle, ['hi', '1'], 'hi1_rnnoise')
        self.Hardware_Input_2_Noisetorch.connect('toggled', self.rnnoise_toggle, ['hi', '2'], 'hi2_rnnoise')
        self.Hardware_Input_3_Noisetorch.connect('toggled', self.rnnoise_toggle, ['hi', '3'], 'hi3_rnnoise')

        self.Hardware_Input_1_Noisetorch.connect("button_press_event", self.rnnoise_popop, ['hi', '1'])
        self.Hardware_Input_2_Noisetorch.connect("button_press_event", self.rnnoise_popop, ['hi', '2'])
        self.Hardware_Input_3_Noisetorch.connect("button_press_event", self.rnnoise_popop, ['hi', '3'])

        self.Hardware_Input_1_A1 = self.builder.get_object('Hardware_Input_1_A1')
        self.Hardware_Input_1_A2 = self.builder.get_object('Hardware_Input_1_A2')
        self.Hardware_Input_1_A3 = self.builder.get_object('Hardware_Input_1_A3')
        self.Hardware_Input_1_B1 = self.builder.get_object('Hardware_Input_1_B1')
        self.Hardware_Input_1_B2 = self.builder.get_object('Hardware_Input_1_B2')
        self.Hardware_Input_1_B3 = self.builder.get_object('Hardware_Input_1_B3')
        self.Hardware_Input_1_A1.set_active(self.config['hi']['1']['a1'])
        self.Hardware_Input_1_A2.set_active(self.config['hi']['1']['a2'])
        self.Hardware_Input_1_A3.set_active(self.config['hi']['1']['a3'])
        self.Hardware_Input_1_B1.set_active(self.config['hi']['1']['b1'])
        self.Hardware_Input_1_B2.set_active(self.config['hi']['1']['b2'])
        self.Hardware_Input_1_B3.set_active(self.config['hi']['1']['b3'])
        self.Hardware_Input_1_A1.connect("toggled", self.loopback_toggle, ['a', '1'], ['hi', '1'])
        self.Hardware_Input_1_A2.connect("toggled", self.loopback_toggle, ['a', '2'], ['hi', '1'])
        self.Hardware_Input_1_A3.connect("toggled", self.loopback_toggle, ['a', '3'], ['hi', '1'])
        self.Hardware_Input_1_B1.connect("toggled", self.loopback_toggle, ['b', '1'], ['hi', '1'])
        self.Hardware_Input_1_B2.connect("toggled", self.loopback_toggle, ['b', '2'], ['hi', '1'])
        self.Hardware_Input_1_B3.connect("toggled", self.loopback_toggle, ['b', '3'], ['hi', '1'])

        self.Hardware_Input_1_A1.connect("button_press_event", self.loopback_latency_popop, ['hi', '1', 'a1'])
        self.Hardware_Input_1_A2.connect("button_press_event", self.loopback_latency_popop, ['hi', '1', 'a2'])
        self.Hardware_Input_1_A3.connect("button_press_event", self.loopback_latency_popop, ['hi', '1', 'a3'])
        self.Hardware_Input_1_B1.connect("button_press_event", self.loopback_latency_popop, ['hi', '1', 'b1'])
        self.Hardware_Input_1_B2.connect("button_press_event", self.loopback_latency_popop, ['hi', '1', 'b2'])
        self.Hardware_Input_1_B3.connect("button_press_event", self.loopback_latency_popop, ['hi', '1', 'b3'])

        self.Hardware_Input_2_Label = self.builder.get_object('Hardware_Input_2')
        self.Hardware_Input_2_Adjust = self.builder.get_object('Hardware_Input_2_Adjust')
        self.Hardware_Input_2_Adjust.set_value(self.config['hi']['2']['vol'])
        self.Hardware_Input_2_Adjust.connect('value-changed', self.slider_change, "source", ['hi', '2'])
        self.Hardware_Input_2_A1 = self.builder.get_object('Hardware_Input_2_A1')
        self.Hardware_Input_2_A2 = self.builder.get_object('Hardware_Input_2_A2')
        self.Hardware_Input_2_A3 = self.builder.get_object('Hardware_Input_2_A3')
        self.Hardware_Input_2_B1 = self.builder.get_object('Hardware_Input_2_B1')
        self.Hardware_Input_2_B2 = self.builder.get_object('Hardware_Input_2_B2')
        self.Hardware_Input_2_B3 = self.builder.get_object('Hardware_Input_2_B3')
        self.Hardware_Input_2_A1.set_active(self.config['hi']['2']['a1'])
        self.Hardware_Input_2_A2.set_active(self.config['hi']['2']['a2'])
        self.Hardware_Input_2_A3.set_active(self.config['hi']['2']['a3'])
        self.Hardware_Input_2_B1.set_active(self.config['hi']['2']['b1'])
        self.Hardware_Input_2_B2.set_active(self.config['hi']['2']['b2'])
        self.Hardware_Input_2_B3.set_active(self.config['hi']['2']['b3'])
        self.Hardware_Input_2_A1.connect("toggled", self.loopback_toggle, ['a', '1'], ['hi', '2'])
        self.Hardware_Input_2_A2.connect("toggled", self.loopback_toggle, ['a', '2'], ['hi', '2'])
        self.Hardware_Input_2_A3.connect("toggled", self.loopback_toggle, ['a', '3'], ['hi', '2'])
        self.Hardware_Input_2_B1.connect("toggled", self.loopback_toggle, ['b', '1'], ['hi', '2'])
        self.Hardware_Input_2_B2.connect("toggled", self.loopback_toggle, ['b', '2'], ['hi', '2'])
        self.Hardware_Input_2_B3.connect("toggled", self.loopback_toggle, ['b', '3'], ['hi', '2'])

        self.Hardware_Input_2_A1.connect("button_press_event", self.loopback_latency_popop, ['hi', '2', 'a1'])
        self.Hardware_Input_2_A2.connect("button_press_event", self.loopback_latency_popop, ['hi', '2', 'a2'])
        self.Hardware_Input_2_A3.connect("button_press_event", self.loopback_latency_popop, ['hi', '2', 'a3'])
        self.Hardware_Input_2_B1.connect("button_press_event", self.loopback_latency_popop, ['hi', '2', 'b1'])
        self.Hardware_Input_2_B2.connect("button_press_event", self.loopback_latency_popop, ['hi', '2', 'b2'])
        self.Hardware_Input_2_B3.connect("button_press_event", self.loopback_latency_popop, ['hi', '2', 'b3'])

        self.Hardware_Input_3_Label = self.builder.get_object('Hardware_Input_3')
        self.Hardware_Input_3_Adjust = self.builder.get_object('Hardware_Input_3_Adjust')
        self.Hardware_Input_3_Adjust.set_value(self.config['hi']['3']['vol'])
        self.Hardware_Input_3_Adjust.connect('value-changed', self.slider_change, "source", ['hi', '3'])
        self.Hardware_Input_3_A1 = self.builder.get_object('Hardware_Input_3_A1')
        self.Hardware_Input_3_A2 = self.builder.get_object('Hardware_Input_3_A2')
        self.Hardware_Input_3_A3 = self.builder.get_object('Hardware_Input_3_A3')
        self.Hardware_Input_3_B1 = self.builder.get_object('Hardware_Input_3_B1')
        self.Hardware_Input_3_B2 = self.builder.get_object('Hardware_Input_3_B2')
        self.Hardware_Input_3_B3 = self.builder.get_object('Hardware_Input_3_B3')
        self.Hardware_Input_3_A1.set_active(self.config['hi']['3']['a1'])
        self.Hardware_Input_3_A2.set_active(self.config['hi']['3']['a2'])
        self.Hardware_Input_3_A3.set_active(self.config['hi']['3']['a3'])
        self.Hardware_Input_3_B1.set_active(self.config['hi']['3']['b1'])
        self.Hardware_Input_3_B2.set_active(self.config['hi']['3']['b2'])
        self.Hardware_Input_3_B3.set_active(self.config['hi']['3']['b3'])
        self.Hardware_Input_3_A1.connect("toggled", self.loopback_toggle, ['a', '1'], ['hi', '3'])
        self.Hardware_Input_3_A2.connect("toggled", self.loopback_toggle, ['a', '2'], ['hi', '3'])
        self.Hardware_Input_3_A3.connect("toggled", self.loopback_toggle, ['a', '3'], ['hi', '3'])
        self.Hardware_Input_3_B1.connect("toggled", self.loopback_toggle, ['b', '1'], ['hi', '3'])
        self.Hardware_Input_3_B2.connect("toggled", self.loopback_toggle, ['b', '2'], ['hi', '3'])
        self.Hardware_Input_3_B3.connect("toggled", self.loopback_toggle, ['b', '3'], ['hi', '3'])

        self.Hardware_Input_3_A1.connect("button_press_event", self.loopback_latency_popop, ['hi', '3', 'a1'])
        self.Hardware_Input_3_A2.connect("button_press_event", self.loopback_latency_popop, ['hi', '3', 'a2'])
        self.Hardware_Input_3_A3.connect("button_press_event", self.loopback_latency_popop, ['hi', '3', 'a3'])
        self.Hardware_Input_3_B1.connect("button_press_event", self.loopback_latency_popop, ['hi', '3', 'b1'])
        self.Hardware_Input_3_B2.connect("button_press_event", self.loopback_latency_popop, ['hi', '3', 'b2'])
        self.Hardware_Input_3_B3.connect("button_press_event", self.loopback_latency_popop, ['hi', '3', 'b3'])

        
        self.Popover = self.builder.get_object('Popover')
        self.Popover_Entry = self.builder.get_object('Popover_Entry')
        self.Popover_Entry.connect('activate', self.set_popup_entry)

        self.Virtual_Input_1_Label = self.builder.get_object('Virtual_Input_1_Label')
        self.Virtual_Input_1_Label_Event_Box = self.builder.get_object('Virtual_Input_1_Label_Event_Box')
        self.Virtual_Input_1_Label_Event_Box.connect('button_press_event', self.label_click, self.Virtual_Input_1_Label, ['vi', '1'])
        self.Virtual_Input_1_Label.set_text(self.config['vi']['1']['name'] if self.config['vi']['1']['name'] != '' else 'Hardware_Input_1')

        self.Virtual_Input_1_Adjust = self.builder.get_object('Virtual_Input_1_Adjust')
        self.Virtual_Input_1_Adjust.set_value(self.config['vi']['1']['vol'])
        self.Virtual_Input_1_Adjust.connect('value-changed', self.slider_change, "sink", ['vi', '1'])

        self.Virtual_Input_1_A1 = self.builder.get_object('Virtual_Input_1_A1')
        self.Virtual_Input_1_A2 = self.builder.get_object('Virtual_Input_1_A2')
        self.Virtual_Input_1_A3 = self.builder.get_object('Virtual_Input_1_A3')
        self.Virtual_Input_1_B1 = self.builder.get_object('Virtual_Input_1_B1')
        self.Virtual_Input_1_B2 = self.builder.get_object('Virtual_Input_1_B2')
        self.Virtual_Input_1_B3 = self.builder.get_object('Virtual_Input_1_B3')
        self.Virtual_Input_1_A1.set_active(self.config['vi']['1']['a1'])
        self.Virtual_Input_1_A2.set_active(self.config['vi']['1']['a2'])
        self.Virtual_Input_1_A3.set_active(self.config['vi']['1']['a3'])
        self.Virtual_Input_1_B1.set_active(self.config['vi']['1']['b1'])
        self.Virtual_Input_1_B2.set_active(self.config['vi']['1']['b2'])
        self.Virtual_Input_1_B3.set_active(self.config['vi']['1']['b3'])
        self.Virtual_Input_1_A1.connect("toggled", self.loopback_toggle, ['a', '1'], ['vi', '1'])
        self.Virtual_Input_1_A2.connect("toggled", self.loopback_toggle, ['a', '2'], ['vi', '1'])
        self.Virtual_Input_1_A3.connect("toggled", self.loopback_toggle, ['a', '3'], ['vi', '1'])
        self.Virtual_Input_1_B1.connect("toggled", self.loopback_toggle, ['b', '1'], ['vi', '1'])
        self.Virtual_Input_1_B2.connect("toggled", self.loopback_toggle, ['b', '2'], ['vi', '1'])
        self.Virtual_Input_1_B3.connect("toggled", self.loopback_toggle, ['b', '3'], ['vi', '1'])

        self.Virtual_Input_1_A1.connect("button_press_event", self.loopback_latency_popop, ['vi', '1', 'a1'])
        self.Virtual_Input_1_A2.connect("button_press_event", self.loopback_latency_popop, ['vi', '1', 'a2'])
        self.Virtual_Input_1_A3.connect("button_press_event", self.loopback_latency_popop, ['vi', '1', 'a3'])
        self.Virtual_Input_1_B1.connect("button_press_event", self.loopback_latency_popop, ['vi', '1', 'b1'])
        self.Virtual_Input_1_B2.connect("button_press_event", self.loopback_latency_popop, ['vi', '1', 'b2'])
        self.Virtual_Input_1_B3.connect("button_press_event", self.loopback_latency_popop, ['vi', '1', 'b3'])

        

        self.Virtual_Input_2_Label = self.builder.get_object('Virtual_Input_2_Label')
        self.Virtual_Input_2_Label_Event_Box = self.builder.get_object('Virtual_Input_2_Label_Event_Box')
        self.Virtual_Input_2_Label_Event_Box.connect('button_press_event', self.label_click, self.Virtual_Input_2_Label, ['vi', '2'])
        self.Virtual_Input_2_Label.set_text(self.config['vi']['2']['name'] if self.config['vi']['2']['name'] != '' else 'Hardware_Input_2')

        self.Virtual_Input_2_Adjust = self.builder.get_object('Virtual_Input_2_Adjust')
        self.Virtual_Input_2_Adjust.set_value(self.config['vi']['2']['vol'])
        self.Virtual_Input_2_Adjust.connect('value-changed', self.slider_change, "sink", ['vi', '2'])

        self.Virtual_Input_2_A1 = self.builder.get_object('Virtual_Input_2_A1')
        self.Virtual_Input_2_A2 = self.builder.get_object('Virtual_Input_2_A2')
        self.Virtual_Input_2_A3 = self.builder.get_object('Virtual_Input_2_A3')
        self.Virtual_Input_2_B1 = self.builder.get_object('Virtual_Input_2_B1')
        self.Virtual_Input_2_B2 = self.builder.get_object('Virtual_Input_2_B2')
        self.Virtual_Input_2_B3 = self.builder.get_object('Virtual_Input_2_B3')
        self.Virtual_Input_2_A1.set_active(self.config['vi']['2']['a1'])
        self.Virtual_Input_2_A2.set_active(self.config['vi']['2']['a2'])
        self.Virtual_Input_2_A3.set_active(self.config['vi']['2']['a3'])
        self.Virtual_Input_2_B1.set_active(self.config['vi']['2']['b1'])
        self.Virtual_Input_2_B2.set_active(self.config['vi']['2']['b2'])
        self.Virtual_Input_2_B3.set_active(self.config['vi']['2']['b3'])
        self.Virtual_Input_2_A1.connect("toggled", self.loopback_toggle, ['a', '1'], ['vi', '2'])
        self.Virtual_Input_2_A2.connect("toggled", self.loopback_toggle, ['a', '2'], ['vi', '2'])
        self.Virtual_Input_2_A3.connect("toggled", self.loopback_toggle, ['a', '3'], ['vi', '2'])
        self.Virtual_Input_2_B1.connect("toggled", self.loopback_toggle, ['b', '1'], ['vi', '2'])
        self.Virtual_Input_2_B2.connect("toggled", self.loopback_toggle, ['b', '2'], ['vi', '2'])
        self.Virtual_Input_2_B3.connect("toggled", self.loopback_toggle, ['b', '3'], ['vi', '2'])

        self.Virtual_Input_2_A1.connect("button_press_event", self.loopback_latency_popop, ['vi', '2', 'a1'])
        self.Virtual_Input_2_A2.connect("button_press_event", self.loopback_latency_popop, ['vi', '2', 'a2'])
        self.Virtual_Input_2_A3.connect("button_press_event", self.loopback_latency_popop, ['vi', '2', 'a3'])
        self.Virtual_Input_2_B1.connect("button_press_event", self.loopback_latency_popop, ['vi', '2', 'b1'])
        self.Virtual_Input_2_B2.connect("button_press_event", self.loopback_latency_popop, ['vi', '2', 'b2'])
        self.Virtual_Input_2_B3.connect("button_press_event", self.loopback_latency_popop, ['vi', '2', 'b3'])

        self.Virtual_Input_3_Label = self.builder.get_object('Virtual_Input_3_Label')
        self.Virtual_Input_3_Label_Event_Box = self.builder.get_object('Virtual_Input_3_Label_Event_Box')
        self.Virtual_Input_3_Label_Event_Box.connect('button_press_event', self.label_click, self.Virtual_Input_3_Label, ['vi', '3'])
        self.Virtual_Input_3_Label.set_text(self.config['vi']['3']['name'] if self.config['vi']['3']['name'] != '' else 'Hardware_Input_3')
        self.Virtual_Input_3_Adjust = self.builder.get_object('Virtual_Input_3_Adjust')
        self.Virtual_Input_3_Adjust.set_value(self.config['vi']['3']['vol'])
        self.Virtual_Input_3_Adjust.connect('value-changed', self.slider_change, "sink", ['vi', '3'])
        self.Virtual_Input_3_A1 = self.builder.get_object('Virtual_Input_3_A1')
        self.Virtual_Input_3_A2 = self.builder.get_object('Virtual_Input_3_A2')
        self.Virtual_Input_3_A3 = self.builder.get_object('Virtual_Input_3_A3')
        self.Virtual_Input_3_B1 = self.builder.get_object('Virtual_Input_3_B1')
        self.Virtual_Input_3_B2 = self.builder.get_object('Virtual_Input_3_B2')
        self.Virtual_Input_3_B3 = self.builder.get_object('Virtual_Input_3_B3')
        self.Virtual_Input_3_A1.set_active(self.config['vi']['3']['a1'])
        self.Virtual_Input_3_A2.set_active(self.config['vi']['3']['a2'])
        self.Virtual_Input_3_A3.set_active(self.config['vi']['3']['a3'])
        self.Virtual_Input_3_B1.set_active(self.config['vi']['3']['b1'])
        self.Virtual_Input_3_B2.set_active(self.config['vi']['3']['b2'])
        self.Virtual_Input_3_B3.set_active(self.config['vi']['3']['b3'])
        self.Virtual_Input_3_A1.connect("toggled", self.loopback_toggle, ['a', '1'], ['vi', '3'])
        self.Virtual_Input_3_A2.connect("toggled", self.loopback_toggle, ['a', '2'], ['vi', '3'])
        self.Virtual_Input_3_A3.connect("toggled", self.loopback_toggle, ['a', '3'], ['vi', '3'])
        self.Virtual_Input_3_B1.connect("toggled", self.loopback_toggle, ['b', '1'], ['vi', '3'])
        self.Virtual_Input_3_B2.connect("toggled", self.loopback_toggle, ['b', '2'], ['vi', '3'])
        self.Virtual_Input_3_B3.connect("toggled", self.loopback_toggle, ['b', '3'], ['vi', '3'])

        self.Virtual_Input_3_A1.connect("button_press_event", self.loopback_latency_popop, ['vi', '3', 'a1'])
        self.Virtual_Input_3_A2.connect("button_press_event", self.loopback_latency_popop, ['vi', '3', 'a2'])
        self.Virtual_Input_3_A3.connect("button_press_event", self.loopback_latency_popop, ['vi', '3', 'a3'])
        self.Virtual_Input_3_B1.connect("button_press_event", self.loopback_latency_popop, ['vi', '3', 'b1'])
        self.Virtual_Input_3_B2.connect("button_press_event", self.loopback_latency_popop, ['vi', '3', 'b2'])
        self.Virtual_Input_3_B3.connect("button_press_event", self.loopback_latency_popop, ['vi', '3', 'b3'])


        self.Master_A1_Adjust = self.builder.get_object('Master_A1_Adjust')
        self.Master_A3_Adjust = self.builder.get_object('Master_A3_Adjust')
        self.Master_A2_Adjust = self.builder.get_object('Master_A2_Adjust')

        self.Master_A1_Adjust.set_value(self.config['a']['1']['vol'])
        self.Master_A2_Adjust.set_value(self.config['a']['2']['vol'])
        self.Master_A3_Adjust.set_value(self.config['a']['3']['vol'])

        self.Master_A1_Adjust.connect('value-changed', self.slider_change, "sink", ['a', '1'])
        self.Master_A2_Adjust.connect('value-changed', self.slider_change, "sink", ['a', '2'])
        self.Master_A3_Adjust.connect('value-changed', self.slider_change, "sink", ['a', '3'])


        self.Master_B1_Adjust = self.builder.get_object('Master_B1_Adjust')
        self.Master_B2_Adjust = self.builder.get_object('Master_B2_Adjust')
        self.Master_B3_Adjust = self.builder.get_object('Master_B3_Adjust')

        self.Master_B1_Adjust.set_value(self.config['b']['1']['vol'])
        self.Master_B2_Adjust.set_value(self.config['b']['2']['vol'])
        self.Master_B3_Adjust.set_value(self.config['b']['3']['vol'])
        self.Master_B1_Adjust.connect('value-changed', self.slider_change, "source", ['b', '1'])
        self.Master_B2_Adjust.connect('value-changed', self.slider_change, "source", ['b', '2'])
        self.Master_B3_Adjust.connect('value-changed', self.slider_change, "source", ['b', '3'])

        self.EQ_A1 = self.builder.get_object('EQ_A1')
        self.EQ_A2 = self.builder.get_object('EQ_A2')
        self.EQ_A3 = self.builder.get_object('EQ_A3')
        self.EQ_A1.set_active(self.config['a']['1']['use_eq'])
        self.EQ_A2.set_active(self.config['a']['2']['use_eq'])
        self.EQ_A3.set_active(self.config['a']['3']['use_eq'])
        self.EQ_A1.connect('toggled', self.toggle_eq, ['a', '1'], 'A1_EQ')
        self.EQ_A2.connect('toggled', self.toggle_eq, ['a', '2'], 'A2_EQ')
        self.EQ_A3.connect('toggled', self.toggle_eq, ['a', '3'], 'A3_EQ')
        self.EQ_A1.connect('button_press_event', self.open_eq, ['a', '1'], 'A1_EQ')
        self.EQ_A2.connect('button_press_event', self.open_eq, ['a', '2'], 'A2_EQ')
        self.EQ_A3.connect('button_press_event', self.open_eq, ['a', '3'], 'A3_EQ')

        self.EQ_B1 = self.builder.get_object('EQ_B1')
        self.EQ_B2 = self.builder.get_object('EQ_B2')
        self.EQ_B3 = self.builder.get_object('EQ_B3')
        self.EQ_B1.set_active(self.config['b']['1']['use_eq'])
        self.EQ_B2.set_active(self.config['b']['2']['use_eq'])
        self.EQ_B3.set_active(self.config['b']['3']['use_eq'])
        self.EQ_B1.connect('toggled', self.toggle_eq, ['b', '1'], 'B1_EQ')
        self.EQ_B2.connect('toggled', self.toggle_eq, ['b', '2'], 'B2_EQ')
        self.EQ_B3.connect('toggled', self.toggle_eq, ['b', '3'], 'B3_EQ')
        self.EQ_B1.connect('button_press_event', self.open_eq, ['b', '1'], 'B1_EQ')
        self.EQ_B2.connect('button_press_event', self.open_eq, ['b', '2'], 'B2_EQ')
        self.EQ_B3.connect('button_press_event', self.open_eq, ['b', '3'], 'B3_EQ')

        self.Mute_A1 = self.builder.get_object('Mute_A1')
        self.Mute_A2 = self.builder.get_object('Mute_A2')
        self.Mute_A3 = self.builder.get_object('Mute_A3')
        self.Mute_A1.set_active(self.config['a']['1']['mute'])
        self.Mute_A2.set_active(self.config['a']['2']['mute'])
        self.Mute_A3.set_active(self.config['a']['3']['mute'])
        self.Mute_A1.connect('toggled', self.mute_toggle, ['a', '1'], 'sink')
        self.Mute_A2.connect('toggled', self.mute_toggle, ['a', '2'], 'sink')
        self.Mute_A3.connect('toggled', self.mute_toggle, ['a', '3'], 'sink')

        self.Mute_B1 = self.builder.get_object('Mute_B1')
        self.Mute_B2 = self.builder.get_object('Mute_B2')
        self.Mute_B3 = self.builder.get_object('Mute_B3')
        self.Mute_B1.set_active(self.config['b']['1']['mute'])
        self.Mute_B2.set_active(self.config['b']['2']['mute'])
        self.Mute_B3.set_active(self.config['b']['3']['mute'])
        self.Mute_B1.connect('toggled', self.mute_toggle, ['b', '1'], 'source')
        self.Mute_B2.connect('toggled', self.mute_toggle, ['b', '2'], 'source')
        self.Mute_B3.connect('toggled', self.mute_toggle, ['b', '3'], 'source')
        self.init = False


        self.Window = self.builder.get_object('Window')

        self.Window.connect("delete_event", self.delete_event, self.config)

        self.Window.set_type_hint(Gdk.WindowTypeHint.DIALOG)

        self.builder.connect_signals(self)
        self.Window.show_all()


    def slider_change(self, slider, device_type, index):
        val = int(slider.get_value())
        self.pulse.volume(self.config, device_type, index, val)

    def toggle_eq(self, button, index, name):
        command = ''
        if button.get_active() == True:
            control = self.config[index[0]][index[1]]['eq_control']
            self.pulse.apply_eq(self.config, index, name, control)
        else:
            master = self.config[index[0]][index[1]]['name']
            self.pulse.remove_eq(self.config, master, name, index[0] + index[1], index)

    def rnnoise_toggle(self, widget, source_index, sink_name):
        stat = 'connect' if widget.get_active() == True else 'disconnect'
        self.pulse.rnnoise(self.config, source_index, sink_name, stat)

    def mute_toggle(self, button, index, device):
        state = 1 if button.get_active() else 0
        self.pulse.mute(self.config, index, device, state)

    def loopback_toggle(self, button, sink_index, source_index):
        state = "connect" if button.get_active() else "disconnect"
        self.pulse.connect(self.config, state, source_index, sink_index)

    def loopback_latency_popop(self, widget, event, index):
        if event.button == 3:
            Latency_Popup(widget, self.pulse, self.config, self.gladefile, index)

    def rnnoise_popop(self, widget, event, index):
        if event.button == 3:
            Noisetorch_Popup(widget, self.config, self.pulse, self.gladefile, index)

    def open_eq(self, button, event, index, name):
        if event.button == 3:
            if self.config[index[0]][index[1]]['name'] == '':
                return

            EqPopover(button, self.config, self.pulse, self.gladefile, index, name)

    def set_popup_entry(self, widget):
        name = widget.get_text()
        if self.pulse.rename(self.config, self.Label_Index, name) == True:
            self.PopActive.set_text(name)

        self.Popover.popdown()

    def label_click(self, widget, event, label, index):
        self.Label_Index = index
        self.Popover.set_relative_to(widget)
        self.Popover.popup()
        self.PopActive = label

    def on_combo_changed(self, widget, index, device):
        model = widget.get_active()
        if model > 0:
            self.config[index[0]][index[1]]['name'] = device[model - 1][0]
        else:
            self.config[index[0]][index[1]]['name'] = ""

    def delete_event(self, widget, event, donnees=None):
        with open(get_config_path(), 'w') as outfile:
            json.dump(self.config, outfile, indent='\t', separators=(',', ': '))
        Gtk.main_quit()
        return False

def save_config(path):
    with open('config.json', 'w') as outfile:
        json.dump(self.config, outfile, indent='\t', separators=(',', ': '))


def cmd(command):
    sys.stdout.flush()
    MyOut = subprocess.Popen(command.split(' '), 
        stdout=subprocess.PIPE, 
        stderr=subprocess.STDOUT)
    stdout,stderr = MyOut.communicate()
    return stdout.decode()

def get_config_path(glade=False):
    config_path = os.getenv('XDG_CONFIG_HOME')
    if config_path == None:
        config_path = os.getenv('HOME')
        config_path = os.path.join(config_path,'.config')
    config_path = os.path.join(config_path,'pulsemeeter')
    Path(config_path).mkdir(parents=True, exist_ok=True)
    config_file = os.path.join(config_path,'config.json')
    glade_file = os.path.join(config_path,'Interface.glade')
    if glade == True:
        return glade_file
    return config_file

def is_running():
    try:
        with open(PIDFILE) as f:
            pid = int(next(f))
        return os.kill(pid, 0)
    except Exception:
        return False

def main():
    config_orig='{"a": {"1": {"name": "", "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}, "2": {"name": "", "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}, "3": {"name": "", "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}}, "b": {"1": {"name": "Mic", "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}, "2": {"name": "Mic_Aux", "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}, "3": {"name": "Mic_Aux_2", "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}}, "vi": {"1": {"name": "Virtual_Sink", "a1": false, "a2": false, "a3": false, "b1": false, "b2": false, "b3": false, "a1_latency": 200, "a2_latency": 200, "a3_latency": 200, "b1_latency": 200, "b2_latency": 200, "b3_latency": 200, "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}, "2": {"name": "Virtual_Sink_Aux", "a1": false, "a2": false, "a3": false, "b1": false, "b2": false, "b3": false, "a1_latency": 200, "a2_latency": 200, "a3_latency": 200, "b1_latency": 200, "b2_latency": 200, "b3_latency": 200, "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}, "3": {"name": "Virtual_Sink_Aux_2", "a1": false, "a2": false, "a3": false, "b1": false, "b2": false, "b3": false, "a1_latency": 200, "a2_latency": 200, "a3_latency": 200, "b1_latency": 200, "b2_latency": 200, "b3_latency": 200, "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false}}, "hi": {"1": {"name": "", "a1": false, "a2": false, "a3": false, "b1": false, "b2": false, "b3": false, "a1_latency": 200, "a2_latency": 200, "a3_latency": 200, "b1_latency": 200, "b2_latency": 200, "b3_latency": 200, "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false, "use_rnnoise": false, "rnnoise_name": "", "rnnoise_control": 95, "rnnoise_latency": 200}, "2": {"name": "", "a1": false, "a2": false, "a3": false, "b1": false, "b2": false, "b3": false, "a1_latency": 200, "a2_latency": 200, "a3_latency": 200, "b1_latency": 200, "b2_latency": 200, "b3_latency": 200, "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false, "use_rnnoise": false, "rnnoise_name": "", "rnnoise_control": 95, "rnnoise_latency": 200}, "3": {"name": "", "a1": false, "a2": false, "a3": false, "b1": false, "b2": false, "b3": false, "a1_latency": 200, "a2_latency": 200, "a3_latency": 200, "b1_latency": 200, "b2_latency": 200, "b3_latency": 200, "vol": 100, "mute": false, "eq_control": "", "eq_name": "", "use_eq": false, "use_rnnoise": false, "rnnoise_name": "", "rnnoise_control": 95, "rnnoise_latency": 200}}}'
    config_orig = json.loads(config_orig)
    config_file = get_config_path()
    config = None
    if not os.path.isfile(config_file):
        config = config_orig
        with open(config_file, 'w') as outfile:
            json.dump(config, outfile, indent='\t', separators=(',', ': '))
    else:
        config = json.load(open(config_file))
        changed = False
        for i in ['a', 'b', 'vi', 'hi']:
            for j in range(1, 4):
                for k in config_orig[i][str(j)]:
                    if not k in config[i][str(j)]:
                        changed = True
                        config[i][str(j)][k] = config_orig[i][str(j)][k]
        if changed == True:
            with open(config_file, 'w') as outfile:
                json.dump(config, outfile, indent='\t', separators=(',', ': '))
    # config = json.load(open('config.json'))
    pulse = Pulse(config)
    if len(sys.argv) > 1 and sys.argv[1] == 'init':
        exit()
    app = MainWindow(config, pulse)
    return Gtk.main()


if __name__ == '__main__':
    if is_running() != False:
        print('Another copy is already running')
        sys.exit(0)
    with open(PIDFILE, 'w') as f:
        f.write(f'{os.getpid()}\n')
    mainret = main()
    sys.exit(mainret)
